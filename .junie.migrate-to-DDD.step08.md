# üöÄ Updated IoT Pilot Server DDD Structure - Step 8

## üåê Task 8: Phase 8 - API Routes Refactoring (4-6 days)

### üéØ Overview
This phase focuses on refactoring the API routes to integrate with the new DDD architecture. The API routes will be transformed into thin controllers that delegate to the appropriate command and query handlers.

### üìã Tasks

#### Task 8.1: Refactor Device API Routes
- Refactor GET /api/devices to use ListDevices query
- Refactor POST /api/devices to use RegisterDevice command
- Refactor GET /api/devices/[id] to use GetDevice query
- Refactor PUT /api/devices/[id] to use UpdateDevice command
- Refactor DELETE /api/devices/[id] to use RemoveDevice command
- Refactor POST /api/devices/[id]/ssh to use ExecuteSSHCommand command
- Refactor GET /api/devices/[id]/metrics to use GetDeviceMetrics query
- Refactor GET /api/devices/[id]/status to use GetDeviceStatus query
- Refactor POST /api/devices/register to use RegisterDevice command
- Refactor POST /api/devices/bulk to use BulkRegisterDevices command

#### Task 8.2: Refactor Auth API Routes
- Refactor POST /api/auth/login to use AuthenticateUser command
- Refactor POST /api/auth/logout to use LogoutUser command
- Refactor POST /api/auth/register to use RegisterUser command
- Refactor GET /api/auth/session to use ValidateSession query
- Refactor POST /api/auth/refresh to use RefreshSession command

#### Task 8.3: Refactor User API Routes
- Refactor GET /api/users to use ListUsers query
- Refactor POST /api/users to use RegisterUser command
- Refactor GET /api/users/[id] to use GetUserById query
- Refactor PUT /api/users/[id] to use UpdateUser command
- Refactor DELETE /api/users/[id] to use RemoveUser command
- Refactor GET /api/users/[id]/profile to use GetUserProfile query
- Refactor PUT /api/users/[id]/profile to use UpdateUserProfile command
- Refactor GET /api/users/current to use GetCurrentUser query

#### Task 8.4: Refactor Monitoring API Routes
- Refactor GET /api/monitoring/metrics to use GetSystemMetrics query
- Refactor GET /api/monitoring/alerts to use ListAlerts query
- Refactor POST /api/monitoring/alerts to use CreateAlert command
- Refactor GET /api/monitoring/alerts/[id] to use GetAlertDetails query
- Refactor PUT /api/monitoring/alerts/[id] to use AcknowledgeAlert or ResolveAlert command
- Refactor DELETE /api/monitoring/alerts/[id] to use DeleteAlert command
- Refactor GET /api/monitoring/thresholds to use GetThresholds query
- Refactor POST /api/monitoring/thresholds to use CreateThreshold command
- Refactor GET /api/monitoring/reports to use GenerateReport query

#### Task 8.5: Implement API Middleware
- Implement authentication middleware using ValidateSession query
- Implement error handling middleware
- Implement logging middleware
- Implement CORS middleware
- Implement rate limiting middleware
- Implement validation middleware

#### Task 8.6: Create API Integration Tests
- Integration tests for Device API routes
- Integration tests for Auth API routes
- Integration tests for User API routes
- Integration tests for Monitoring API routes

### ‚úÖ Task 8.7: Phase 8 Validation
- Device API routes refactored
- Auth API routes refactored
- User API routes refactored
- Monitoring API routes refactored
- API middleware implemented
- API integration tests passing
- All existing functionality still works